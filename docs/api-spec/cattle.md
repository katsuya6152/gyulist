# 牛群管理API ビジネスロジック仕様

## 概要

牛群管理システムの中核となるAPIです。牛の登録、検索、更新、削除、ステータス管理などの機能を提供します。

## 認証・認可

- **認証方式**: JWT
- **権限**: 自分の牛のみ操作可能（所有権チェック）
- **エンドポイント**: `/api/v1/cattle/*`

## 依存関係

- `CattleRepoPort`: 牛データの永続化
- `EventsRepoPort`: イベントデータの取得
- `CattleDetailsPort`: 詳細情報の取得
- `BreedingRepoPort`: 繁殖データの管理
- `ClockPort`: 現在時刻の取得

## コアワークフロー

### 1. 牛の一覧取得・検索

```typescript
GET /cattle
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  検索パラメータを検証
  ↓
  カーソルをデコード
  ↓
  リポジトリで牛を検索
  ↓
  結果にページネーションを適用
  ↓
  最後のアイテムから次のカーソルをエンコード
  ↓
  結果、次のカーソル、次のページ有無を返す
```

**ビジネスルール**:
- 無効なカーソルは無視して継続（既存E2Eの振る舞い維持）
- カーソル値は品種別に計算（日齢、ID、名前）
- ページネーションはlimit+1件取得してhas_next判定

### 2. ステータス別頭数取得

```typescript
GET /cattle/status-counts
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  ステータス別に牛の頭数を集計
  ↓
  レスポンス形式に変換
  ↓
  各ステータスの頭数を返す
```

**ビジネスルール**:
- 全ステータスを0で初期化
- 存在するステータスのみカウント値を設定

### 3. 牛の詳細取得

```typescript
GET /cattle/:id
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  牛のIDパラメータを解析
  ↓
  牛の詳細を取得
  ↓
  牛の所有権を検証
  ↓
  所有者でない場合は禁止エラー
  ↓
  関連データを取得
    ├─ イベント: 牛のIDでイベントを検索
    ├─ 繁殖: 牛のIDで繁殖データを検索
    └─ 血統: 牛のIDで血統データを検索
  ↓
  牛の詳細情報を構成
  ↓
  牛の詳細を返す
```

**ビジネスルール**:
- 自分の牛のみ詳細取得可能
- イベント、血統、繁殖データを含む
- 所有権チェックで403エラー

### 4. 牛の新規登録

```typescript
POST /cattle
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  牛の作成スキーマを検証
  ↓
  牛の作成ユースケースを実行
  ↓
  牛の作成コマンドを検証
  ↓
  識別番号の重複をチェック
  ↓
  重複がある場合は競合エラー
  ↓
  牛のドメインオブジェクトを作成
  ↓
  リポジトリに永続化
  ↓
  繁殖ステータスが提供されている場合は繁殖データを初期化
  ↓
  作成された牛を返す
```

**ビジネスルール**:
- 識別番号の重複チェック（現在は無効化中）
- 識別番号は正の整数
- 体重は正の値（提供される場合）
- スコアは0-100の範囲
- 繁殖ステータスが提供される場合、繁殖データを初期化

### 5. 牛の更新

```typescript
PUT /cattle/:id
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  牛のIDパラメータを解析
  ↓
  牛の更新スキーマを検証
  ↓
  牛の更新ユースケースを実行
  ↓
  牛をIDで検索
  ↓
  牛の所有権をチェック
  ↓
  所有者でない場合は禁止エラー
  ↓
  ビジネスルールを検証
  ↓
  リポジトリで牛を更新
  ↓
  更新された牛を返す
```

**ビジネスルール**:
- 自分の牛のみ更新可能
- 更新可能なフィールドの制限
- ビジネスルールの検証

### 6. 牛のステータス更新

```typescript
PATCH /cattle/:id/status
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  牛のIDパラメータを解析
  ↓
  ステータス更新スキーマを検証
  ↓
  ステータス更新ユースケースを実行
  ↓
  牛をIDで検索
  ↓
  牛の所有権をチェック
  ↓
  所有者でない場合は禁止エラー
  ↓
  現在のステータスから新しいステータスへの遷移を検証
  ↓
  無効な遷移の場合は無効ステータス遷移エラー
  ↓
  リポジトリでステータスを更新
  ↓
  ステータスが出荷または死亡に変更された場合は繁殖ステータスを非アクティブに更新
  ↓
  更新された牛を返す
```

**ビジネスルール**:
- 自分の牛のみステータス更新可能
- ステータス遷移の妥当性チェック
- 出荷・死亡時は繁殖ステータスを非アクティブに更新

### 7. 牛の削除

```typescript
DELETE /cattle/:id
  ↓
  JWTでリクエストを認証
  ↓
  JWTペイロードからユーザーIDを抽出
  ↓
  牛のIDパラメータを解析
  ↓
  牛の削除ユースケースを実行
  ↓
  牛をIDで検索
  ↓
  牛の所有権をチェック
  ↓
  所有者でない場合は禁止エラー
  ↓
  リポジトリから牛を削除
  ↓
  削除成功を返す
```

**ビジネスルール**:
- 自分の牛のみ削除可能
- 関連データの整合性チェック

## 副作用・エラーマッピング

### ドメインエラー

```typescript
type CattleDomainError = 
  | ValidationError
  | ConflictError
  | NotFoundError
  | ForbiddenError
  | InfraError
  | BusinessRuleViolationError
```

### エラー処理

```typescript
handleCattleError: (error: CattleDomainError) => HTTPResponse
  ↓
  switch (error.type)
    case "ValidationError": return 400_BadRequest
    case "ConflictError": return 409_Conflict
    case "NotFoundError": return 404_NotFound
    case "ForbiddenError": return 403_Forbidden
    case "InfraError": return 500_InternalServerError
    case "BusinessRuleViolationError": return 422_UnprocessableEntity
```

### 副作用

- データベースの永続化
- 繁殖データの初期化
- ステータス変更時の関連データ更新

## 監査・運用

### ログ出力

- 牛の作成・更新・削除操作
- ステータス変更履歴
- 所有権チェック失敗

### パフォーマンス

- カーソルベースページネーション
- インデックス最適化
- 関連データの効率的な取得

### セキュリティ

- JWT認証
- 所有権チェック
- 入力値検証
- SQLインジェクション対策


