name: TypeDoc Documentation Deploy

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/api/**'
  push:
    branches: [main]
    paths:
      - 'apps/api/**'

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 1. TypeDocÁîüÊàê„Å®„ÉÜ„Çπ„Éà
  build-docs:
    runs-on: ubuntu-latest
    outputs:
      api_changed: ${{ steps.filter.outputs.api }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- Â§âÊõ¥„Éï„Ç°„Ç§„É´„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ ---
      - name: Filter changed paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api:
              - 'apps/api/**'

      - name: Install pnpm
        run: npm install -g pnpm
  
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # --- API„ÅÆ„Éì„É´„ÉâÔºàTypeDocÁîüÊàê„Å´ÂøÖË¶ÅÔºâ ---
      - name: Build API
        if: steps.filter.outputs.api == 'true'
        working-directory: apps/api
        run: pnpm run build

      # --- TypeDocÁîüÊàê ---
      - name: Generate TypeDoc
        if: steps.filter.outputs.api == 'true'
        working-directory: apps/api
        run: pnpm run docs:gen

      # --- ÁîüÊàê„Åï„Çå„Åü„Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆÁ¢∫Ë™ç ---
      - name: List generated docs
        if: steps.filter.outputs.api == 'true'
        run: |
          echo "Generated documentation files:"
          find docs/tsdoc/api -type f -name "*.html" | head -10
          echo "Total HTML files: $(find docs/tsdoc/api -type f -name "*.html" | wc -l)"

      # --- „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Å®„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºàPRÁî®Ôºâ ---
      - name: Upload docs as artifact
        if: steps.filter.outputs.api == 'true' && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: typedoc-docs
          path: docs/tsdoc/api/
          retention-days: 30

  # 2. GitHub Pages„Å∏„ÅÆ„Éá„Éó„É≠„Ç§Ôºàmain„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆpushÊôÇ„ÅÆ„ÅøÔºâ
  deploy:
    runs-on: ubuntu-latest
    needs: build-docs
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    if: >
      github.event_name == 'push' &&
      needs.build-docs.outputs.api_changed == 'true'
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm
  
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # --- API„ÅÆ„Éì„É´„Éâ ---
      - name: Build API
        working-directory: apps/api
        run: pnpm run build

      # --- TypeDocÁîüÊàê ---
      - name: Generate TypeDoc
        working-directory: apps/api
        run: pnpm run docs:gen

      # --- GitHub Pages„Å∏„ÅÆ„Éá„Éó„É≠„Ç§ ---
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/tsdoc/api/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 3. PR„Åß„ÅÆ„Éó„É¨„Éì„É•„ÉºÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
  preview:
    runs-on: ubuntu-latest
    needs: build-docs
    if: >
      github.event_name == 'pull_request' &&
      needs.build-docs.outputs.api_changed == 'true'
    steps:
      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: typedoc-docs
          path: docs/tsdoc/api/

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // ÁîüÊàê„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
              const docsPath = 'docs/tsdoc/api';
              if (fs.existsSync(docsPath)) {
                const files = fs.readdirSync(docsPath);
                const htmlFiles = files.filter(f => f.endsWith('.html'));
                
                const comment = `## üìö TypeDoc Documentation Generated
              
              ‚úÖ TypeDoc documentation has been generated successfully!
              
              **Generated files:** ${htmlFiles.length} HTML files
              **Main file:** \`index.html\`
              
              üì¶ Documentation is available as an artifact in this PR.
              üöÄ Will be deployed to GitHub Pages when merged to main.
              
              **Files generated:**
              \`\`\`
              ${files.slice(0, 10).join('\n')}${files.length > 10 ? '\n...' : ''}
              \`\`\`
              `;
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                
                console.log('‚úÖ PR comment posted successfully');
              } else {
                console.log('‚ö†Ô∏è Documentation directory not found');
              }
            } catch (error) {
              console.log('‚ö†Ô∏è Failed to post PR comment:', error.message);
              console.log('This is not a critical error - workflow will continue');
            }
